name: ðŸš€ continuous-delivery

on:
  push:
    branches:
      - main

jobs:
  semver:
    name: ðŸš€ release new version
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4.1.1
      with:
          token: ${{ secrets.GH_AUTOMATION_TOKEN }}
    - name: release new version
      uses: cangulo-actions/semver@main
      id: semver
      with:
        create-gh-release: true
        print-summary: true
    - name: print semver output
      env:
        CHANGES: ${{ steps.semver.outputs.changes }}
        CHANGELOG_RECORD: ${{ steps.semver.outputs.changelog-record }}
        SCOPES: ${{ steps.semver.outputs.scopes }}
      run: |
        echo "new-version-released:     ${{ steps.semver.outputs.new-version-released }}"
        echo "version:                  ${{ steps.semver.outputs.version }}"
        echo "release-title:            ${{ steps.semver.outputs.release-title }}"
        echo "release-type:             ${{ steps.semver.outputs.release-type }}"
        echo "release-url:              ${{ steps.semver.outputs.release-url }}"
        echo "commit-id:                ${{ steps.semver.outputs.commit-id }}"

        echo "changes:"
        echo "$CHANGES" | jq .

        echo "changes-log:"
        echo "$CHANGELOG_RECORD"

        echo "scopes:"
        echo "$SCOPES" | jq .

    - name: add semver output to GH summary
      uses: actions/github-script@v7
      env:
        SEMVER_OUTPUTS: ${{ toJson(steps.semver.outputs) }}
      with:
        script: |
          const semverOutputs = JSON.parse(process.env.SEMVER_OUTPUTS)

          console.log('semverOutputs', semverOutputs)

          core.summary
            .addHeading('Semver Output:')
            .addCodeBlock(JSON.stringify(semverOutputs, null, 2), 'json')
            .write()      
    